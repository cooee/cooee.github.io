# （一）通过IDE进行性能分析

**工程性能分析**可用于分析操作当前工程时，有哪些函数被调用，以及对应的调用信息。包括调用函数的名称，所在文件及行数，调用时间，次数，以及子函数调用时间，次数等

### 1. 如何使用
![](/assets/help/demo_project_profile.gif "性能分析")
上面的GIF演示了，如何通过性能分析工具，测试加载一个模块的性能消耗。测试工程中有一个按钮，点击按钮会加载一个粉色模块。
主要步骤是
1. 点击`菜单栏-性能分析`，会启动当前工程并连接到IDE
2. IDE弹出Toast表示客户端连接成功，点击`开始分析`启动性能分析
3. 对工程进行想要测试的操作（比如这里的操作是点击按钮，加载粉色模块）
4. 点击`停止`，结束性能分析。此时，IDE窗口会显示出本次操作后的函数调用情况
5. 也可以使用`定时分析`,点击后会按照输入的时间间隔自动进行性能分析

### 2. 性能分析数据说明
* `函数信息`列表示调用函数的名称，函数类型（L代表LUA函数，C代表C函数），所在文件路径，行数
* `时间`列表示该函数调用所占用的时间，`百分比`列表示该函数调用时间占总时间的百分比
* `self`列表示该函数自身所占用的时间，`children`列表示该函数的子函数所占用的时间
* `次数`列表示该函数调用的总次数
![](/assets/help/explain_project_profile.png "说明")
* 点击对应的列名称，会进行向上或向下排序

### 3. 通过数据分析调用情况
仍然以上面的demo为例，在拿到性能分析数据以后，来分析加载粉色模块的过程中，哪些函数被调用，以及哪些函数比较耗时
1. 模块加载首先执行的是该模块的构造函数，找到对应的ctor函数，如下图所示，它的自身耗时是0秒，子函数耗时0.015秒。查看其子函数，是base_view_extend.lua第73行的load_widget函数，耗时0.015秒
![](/assets/help/stack0_project_profile.png "堆栈")
2. 找到load_widget函数（后期会支持双击自动跳转），可以看到其也是子函数调用占用了0.015秒。打开节点发现，require子函数只占用了0.001秒，主要是位于WidgetLoader.lua第47行的子函数load占用了0.014秒
![](/assets/help/stack1_project_profile.png "堆栈")
3. 找到load函数，其下有很多子函数被调用，但主要是位于layout_loader.lua第210行的子函数load占用了0.014秒
![](/assets/help/stack2_project_profile.png "堆栈")
4. 可以继续找到layout_loader.lua中的load函数进行查看，这里不再赘述。以此类推，每个所调用函数的耗时，调用次数，子函数调用情况等都可以找到，再结合实际情况进行分析，如果有函数调用信息与预期不符，则该函数可能存在异常或是耗时过长需要优化。

# （二）通过代码进行性能分析
有时候我们需要知道某段具体代码执行效率是否高效，传统的方法是在代码块前后加上时间统计，看时间差值，也就是代码执行消耗。该方法能解决一定问题，但是并不知道代码运行细节，所以我们可以借助profiler来检测代码执行效率，具体示例如下
```lua
    local newProfiler  = import("bos.core.profiler"); --加载profiler
    local profiler = newProfiler("call"); --具体分析函数调用
    profiler:start();
    --[[
        local viewLayout = viewLayout
        local pkgConfig = {
                UILayout = viewLayout,
                UIRES = res,
        }
        local layoutView = LayoutLoader:loadPkg(pkgConfig,self) --加入要监控的代码段，这里是测试布局文件的加载效率       
        ]]
    profiler:stop();
    profiler:dump_report_to_file( "profile.txt") --输出的文件命名

```
执行完之后生成一份性能分析报告，该文件默认在win32下(win32/profile.txt)，也可以自行制定路劲，具体格式如下:
![](img/profiled.png)
